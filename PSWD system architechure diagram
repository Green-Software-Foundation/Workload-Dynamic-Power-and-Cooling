graph TB
    %% External Systems Layer
    subgraph External ["üåê External Systems"]
        Grid["‚ö° Grid Operators<br/>Load Forecasting<br/>Demand Response<br/>Renewable Coordination"]
        Municipal["üèòÔ∏è Municipal Utilities<br/>District Heating<br/>Waste Heat Recovery<br/>Heat Quality Control"]
        Renewable["üå± Renewable Sources<br/>Solar/Wind Generation<br/>Carbon Intensity Data<br/>Generation Forecasts"]
    end

    %% External Integration Layer
    subgraph Integration ["üîó External Integration Layer"]
        GridAPI["Grid Integration API<br/>IEC 61850-90-4<br/>Real-time Capacity<br/>Frequency Regulation"]
        CarbonTrack["Carbon Tracking<br/>Intensity Monitoring<br/>Renewable Optimization<br/>Emissions Reporting"]
        HeatCoord["Heat Coordination<br/>Municipal Integration<br/>Temperature Control<br/>Flow Management"]
    end

    %% Infrastructure Control Layer
    subgraph Control ["üèóÔ∏è Infrastructure Control Layer"]
        PowerMgmt["Power Management<br/>Load Balancing<br/>Peak Shaving<br/>Emergency Response"]
        BatterySystem["Battery Systems<br/>Energy Storage<br/>Load Smoothing<br/>Grid Services"]
        ThermalMgmt["Thermal Management<br/>Cooling Control<br/>Heat Recovery<br/>Phase Change"]
        PredictiveEngine["Predictive Engine<br/>Load Analytics<br/>Capacity Planning<br/>Optimization"]
    end

    %% Hardware Abstraction Layer
    subgraph Hardware ["üîß Hardware Abstraction Layer"]
        BMC["Enhanced BMC<br/>Redfish API Extension<br/>Sub-second Monitoring<br/>Sensor Aggregation"]
        PowerMon["Power Monitoring<br/>100ms Resolution<br/>¬±0.5% Accuracy<br/>Quality Metrics"]
        ThermalSensor["Thermal Sensors<br/>Temperature: ¬±0.1¬∞C<br/>Flow: ¬±1% Accuracy<br/>Pressure Control"]
        CoolingHW["Cooling Hardware<br/>Single/Two-Phase<br/>Liquid Circulation<br/>Heat Exchangers"]
    end

    %% Workload Interface Layer
    subgraph Interface ["üíª Workload Interface Layer"]
        WorkloadAPI["Workload API<br/>Event-driven Messaging<br/>Sub-second Response<br/>JSON Web Tokens"]
        SchedulerInt["Scheduler Integration<br/>Kubernetes<br/>Resource Managers<br/>Container Orchestration"]
        FlexMgmt["Flexibility Management<br/>Throttling Control<br/>Migration Support<br/>Priority Handling"]
    end

    %% Computational Workloads
    subgraph Workloads ["üß† Computational Workloads"]
        AITrain["AI Training<br/>200+ MW Swings<br/>40ms Transitions<br/>High Priority"]
        AIInfer["AI Inference<br/>Real-time Serving<br/>Variable Load<br/>Low Latency"]
        HPC["HPC Applications<br/>Scientific Computing<br/>Batch Processing<br/>Predictable Load"]
        Traditional["Traditional Compute<br/>Web Services<br/>Databases<br/>Steady State"]
    end

    %% Physical Infrastructure
    subgraph Physical ["‚öôÔ∏è Physical Infrastructure"]
        PowerDist["Power Distribution<br/>Transformers<br/>Circuit Breakers<br/>UPS Systems"]
        BatteryPhys["Battery Storage<br/>Li-ion Arrays<br/>Inverters<br/>Safety Systems"]
        CoolingPhys["Cooling Systems<br/>Liquid Loops<br/>Heat Exchangers<br/>Pumps & Valves"]
        Building["Building Systems<br/>HVAC Integration<br/>Fire Safety<br/>Environmental Control"]
    end

    %% Security Framework
    subgraph Security ["üîí Security Framework"]
        Auth["Authentication<br/>X.509 Certificates<br/>JWT Tokens<br/>Role-based Access"]
        Crypto["Message Security<br/>TLS 1.3<br/>HMAC-SHA256<br/>Digital Signatures"]
        Network["Network Security<br/>VLAN Isolation<br/>Intrusion Detection<br/>Emergency Disconnect"]
    end

    %% External Data Flows
    Grid -.->|Grid Status & Signals| GridAPI
    Renewable -.->|Generation Data| CarbonTrack
    Municipal -.->|Heat Demand| HeatCoord
    
    %% Integration to Control
    GridAPI -->|Demand Response| PowerMgmt
    CarbonTrack -->|Optimization Signals| PredictiveEngine
    HeatCoord -->|Heat Recovery Control| ThermalMgmt
    
    %% Control Layer Interactions
    PowerMgmt -->|Battery Commands| BatterySystem
    PowerMgmt -->|Load Control| PowerMon
    ThermalMgmt -->|Cooling Commands| ThermalSensor
    PredictiveEngine -->|Forecasts| PowerMgmt
    PredictiveEngine -->|Thermal Prep| ThermalMgmt
    
    %% Hardware to Control Feedback
    BMC -->|Hardware Status| PowerMgmt
    PowerMon -->|Real-time Data| PredictiveEngine
    ThermalSensor -->|Temperature Data| ThermalMgmt
    CoolingHW -->|System Status| ThermalSensor
    
    %% Workload Interface
    WorkloadAPI -->|Workload Announcements| PowerMgmt
    WorkloadAPI -->|Resource Requests| ThermalMgmt
    SchedulerInt -->|Job Scheduling| WorkloadAPI
    FlexMgmt -->|Control Commands| WorkloadAPI
    
    %% Workload Connections
    AITrain -->|Power Profile| WorkloadAPI
    AIInfer -->|Resource Needs| WorkloadAPI
    HPC -->|Batch Requests| WorkloadAPI
    Traditional -->|Steady Load| WorkloadAPI
    
    %% Infrastructure Response
    PowerMgmt -.->|Infrastructure Response| WorkloadAPI
    ThermalMgmt -.->|Thermal Status| WorkloadAPI
    BatterySystem -.->|Storage Status| WorkloadAPI
    
    %% Physical Implementation
    PowerMon -->|Measurements| PowerDist
    BatterySystem -->|Charge/Discharge| BatteryPhys
    ThermalSensor -->|Control Signals| CoolingPhys
    ThermalMgmt -->|Building Integration| Building
    
    %% Security Integration
    Auth -.->|Secure Access| WorkloadAPI
    Crypto -.->|Message Integrity| GridAPI
    Network -.->|Traffic Isolation| BMC

    %% Styling for GitHub compatibility
    classDef critical fill:#ffcccc,stroke:#ff0000,stroke-width:2px
    classDef realtime fill:#ccffcc,stroke:#00aa00,stroke-width:2px
    classDef external fill:#ccccff,stroke:#0000aa,stroke-width:2px
    classDef security fill:#ffffcc,stroke:#aaaa00,stroke-width:2px
    
    class AITrain,PowerMon,BatterySystem critical
    class WorkloadAPI,BMC,ThermalSensor realtime
    class Grid,Municipal,Renewable external
    class Auth,Crypto,Network security
